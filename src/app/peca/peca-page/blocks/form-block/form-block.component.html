<form 
  [formGroup]="componentForm" 
  (keydown.enter)="prevDef($event)" 
  (ngSubmit)="onSubmitForm(componentForm)"
>
    <div class="fields-container">
      <ng-container *ngFor="let field of fields; trackBy: trackByFn">
        
        <ng-container *ngIf="isField(field); else titleLabel">
          <div
            [class]="'form-group ' + settings.formsContent[field].type"
            [class.full-width]="settings.formsContent[field].fullwidth"  
            [class.input-group]="settings.formsContent[field].type==='prepend'"        
            [ngSwitch]="settings.formsContent[field].type"
          >
            <ng-container *ngSwitchCase="'email'">
              <input
                class="form-control"
                autocomplete='off'
                type="email"
                [formControlName]="field"
                [id]="field"
                [placeholder]="settings.formsContent[field].placeholder"
                [pattern]="settings.formsContent[field].validations.pattern"
              />
            </ng-container>
            
            <ng-container *ngSwitchCase="'select'">
              <ng-select
                class="form-control"
                notFoundText="Elementos no encontrados"
                [items]="field!='addressMunicipality'? settings.formsContent[field].options : municipalities"
                bindValue="id"
                bindLabel="name"
                [labelForId]="field"
                [formControlName]="field"
                [virtualScroll]="true"
                [id]="field"
                [placeholder]="settings.formsContent[field].placeholder"
                (change)="updateMuns(field==='addressState'? true:false)"
              >
                <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                  <small>{{item.name}}</small>
                </ng-template>
              </ng-select>
            </ng-container>

            <ng-container *ngSwitchCase="'prepend'" [formGroupName]="field">
              <div class="input-group-prepend">
                <ng-select
                  class="form-control"
                  notFoundText="Elementos no encontrados"
                  [items]="settings.formsContent[field].fields['prependSelect'].options"
                  bindValue="id"
                  bindLabel="name"
                  labelForId="prependSelect"
                  formControlName="prependSelect"
                  [virtualScroll]="true"
                  id="prependSelect"
                  [clearable]="false"
                >
                  <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                    <small>{{item.name}}</small>
                  </ng-template>
                </ng-select>              
              </div>
              <input
                class="form-control"
                autocomplete='off'
                type="text"
                formControlName="prependInput" 
                id="prependInput"
                [placeholder]="settings.formsContent[field].fields['prependInput'].placeholder"
              />
              <ng-container *ngIf="hasErrors(field,true)">
                <div class="error-message">
                  <strong>{{hasErrors(field,true)}}</strong>
                </div>
              </ng-container>
            </ng-container>
            
            <ng-container *ngSwitchCase="'date'">
              <input
                #inputDate
                type="date" 
                class="form-control" 
                [formControlName]="field"
                (change)="glbls.validateDate($event,'greater')"
              />
              <input 
                [class.d-none]="inputDate.value.length > 0"
                class="form-control"
                autocomplete='off'
                type="text"              
                [id]="field"
                [placeholder]="settings.formsContent[field].placeholder"
                readonly    
                (click)="focusDatePicker(inputDate)"
              />
              <div class="date-error-message">
                <strong>La fecha debe ser mayor a la de hoy</strong>
              </div>
            </ng-container>

            <ng-container *ngSwitchDefault>
              <!-- <label class="field-label" [for]="field">{{ settings.formsContent[field].label }}</label> -->
              <input
                class="form-control"
                autocomplete='off'
                [type]="settings.formsContent[field].type"
                [formControlName]="field"
                [id]="field"
                [placeholder]="settings.formsContent[field].placeholder"
              />
            </ng-container>

            <ng-container *ngIf="hasErrors(field)">
              <div class="error-message">
                <strong>{{hasErrors(field)}}</strong>
              </div>
            </ng-container>
          </div>
        </ng-container>
        
        <ng-template #titleLabel>          
            <ng-container *ngIf="settings.formsContent[field].type==='title'; else imageGroup">
              <h6>{{ settings.formsContent[field].label }}</h6>
            </ng-container>
        </ng-template>

        <ng-template #imageGroup>
            <div 
              [formGroupName]="field" 
              class="image-group d-flex flex-wrap"
            >
              <!-- camera-outline -->
              <div
                #imageUploadContainer 
                class="image-upload-btn-container" 
                id="image-upload-btn-container"
              >
                  <input class="d-none" id="image-upload-btn-input-file" type="file" />
                  <button 
                    type="button"
                    id="image-upload-btn"  
                    title="Subir archivo"
                    class="text-decoration-none"
                  >
                      <nb-icon icon="planificacion"></nb-icon>
                  </button>
              </div>

              <div class="image-fields d-flex flex-column justify-content-center">
                  <input
                    class="form-control image-description"
                    autocomplete='off'
                    type="text"
                    formControlName="imageDescription"
                    id="imageDescription"
                    [placeholder]="settings.formsContent[field].fields['imageDescription'].placeholder"
                  />

                  <ng-select
                    class="form-control image-status"
                    notFoundText="Elementos no encontrados"
                    [items]="settings.formsContent[field].fields['imageStatus'].options"
                    bindValue="id"
                    bindLabel="name"
                    labelForId="imageStatus"
                    formControlName="imageStatus"
                    [virtualScroll]="true"
                    id="imageStatus"
                    [placeholder]="settings.formsContent[field].fields['imageStatus'].placeholder"
                  >
                    <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                      <small>{{item.name}}</small>
                    </ng-template>
                  </ng-select>
              </div>  

              <div class="add-img-btn">
                <button 
                  type="button" 
                  class="btn btn-primary text-decoration-none py-1 px-4 mt-1 add-img-button"
                >Agregar imagen
                </button>

              </div>            
            </div> 
        </ng-template>
      </ng-container>        

      <div class="btn-container">
        <ng-container
          *ngFor="let btn of settings.buttons" 
          [ngSwitch]="btn"
        >
          <ng-container *ngSwitchCase="'cargarImagenes'">
            <button 
              type="button" 
              class="btn btn-primary text-decoration-none py-1 px-4 mt-1"
              [disabled]="!componentForm.valid || sendingForm"
            >
              <span *ngIf="sendingForm" class="spinner-grow spinner-grow-sm"></span>
              {{ !sendingForm? 'Cargar imagenes':'Cargando..' }}
            </button>
          </ng-container>

          <ng-container *ngSwitchCase="'guardar'">
            <button 
              type="submit" 
              class="btn btn-primary text-decoration-none py-1 px-4 mt-1 submit-btn"
              [disabled]="!componentForm.valid || sendingForm"
            >
              <span *ngIf="sendingForm" class="spinner-grow spinner-grow-sm"></span>
              {{ !sendingForm? 'Guardar':'Guardando..' }}
            </button>
          </ng-container>
          <ng-container *ngSwitchCase="'editar'">
            <button 
              type="submit" 
              class="btn btn-primary text-decoration-none py-1 px-4 mt-1 submit-btn"
              [disabled]="!componentForm.valid || sendingForm"
            >
              <span *ngIf="sendingForm" class="spinner-grow spinner-grow-sm"></span>
              {{ !sendingForm? 'Editar':'Editando..' }}
            </button>
          </ng-container>  
          <ng-container *ngSwitchDefault>
            <button 
              type="submit" 
              class="btn btn-primary text-decoration-none py-1 px-4 mt-1 submit-btn"
              [disabled]="!componentForm.valid || sendingForm"
            >
              <span>Cancelar</span>
            </button>
          </ng-container>       

        </ng-container>          
      </div>        
    </div>
</form>