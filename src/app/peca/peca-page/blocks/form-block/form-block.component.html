<form 
  [formGroup]="componentForm" 
  (keydown.enter)="prevDef($event)" 
  (ngSubmit)="onSubmitForm(componentForm)"
>
    <div 
      class="fields-container"
      [class.one-row-form]="settings.isOneRow"
    >
      <ng-container *ngFor="let field of fields; trackBy: trackByFn">
        
        <ng-container *ngIf="isField(field); else titleLabel">
          <div
            [class]="settings.formsContent[field].type"
            [ngClass]="{ 'form-group'              : settings.formsContent[field].type!='double',
                         'full-width'              : settings.formsContent[field].type!='double' && settings.formsContent[field].fullwidth,
                         'input-group'             : settings.formsContent[field].type==='prepend',
                         'two-wrapper'             : settings.formsContent[field].type==='double',
                         'one-row-form-form-group' : settings.isOneRow,
                         'full-width2'             : settings.formsContent[field].fullwidth2 }"    
            [ngSwitch]="settings.formsContent[field].type"
          >
            <ng-container *ngSwitchCase="'email'">
              <label>{{ settings.formsContent[field].label }}</label>
              <input
                class="form-control"
                autocomplete='off'
                type="email"
                [formControlName]="field"
                [id]="getId(field)"
                [placeholder]="settings.formsContent[field].placeholder"
                [pattern]="settings.formsContent[field].validations.pattern"
              />
            </ng-container>
            
            <ng-container *ngSwitchCase="'select'">
              <label>{{ settings.formsContent[field].label }}</label>
              <ng-select
                class="form-control"
                [class.is-in-modal]="settings.isFromCustomTableActions"
                notFoundText="Elementos no encontrados"
                [items]="field!='addressMunicipality'? settings.formsContent[field].options : municipalities"
                bindValue="id"
                bindLabel="name"
                [labelForId]="getId(field)"
                [formControlName]="field"
                [virtualScroll]="true"
                [id]="getId(field)"
                [placeholder]="settings.formsContent[field].placeholder"
                (change)="updateMuns(field==='addressState'? true:false)"
              >
                <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                  <small>{{item.name}}</small>
                </ng-template>
              </ng-select>
            </ng-container>

            <ng-container *ngSwitchCase="'prepend'" [formGroupName]="field">
              <label>{{ settings.formsContent[field].fields['prependInput'].label }}</label>
              <div class="input-group-prepend">
                <ng-select
                  class="form-control"
                  notFoundText="Elementos no encontrados"
                  [items]="settings.formsContent[field].fields['prependSelect'].options"
                  bindValue="id"
                  bindLabel="name"
                  [labelForId]="getId('prependSelect')"
                  formControlName="prependSelect"
                  [virtualScroll]="true"
                  [id]="getId('prependSelect')"
                  [clearable]="false"
                >
                  <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                    <small>{{item.name}}</small>
                  </ng-template>
                </ng-select>              
              </div>
              <input
                class="form-control"
                autocomplete='off'
                type="text"
                formControlName="prependInput" 
                [id]="getId('prependInput')"
                [placeholder]="settings.formsContent[field].fields['prependInput'].placeholder"
              />
              <ng-container *ngIf="hasErrors(field,true)">
                <div class="error-message">
                  <strong>{{hasErrors(field,true)}}</strong>
                </div>
              </ng-container>
            </ng-container>
            
            <ng-container *ngSwitchCase="'date'">
              <label>{{ settings.formsContent[field].label }}</label>
              <div class="date-container">
                <input
                  #inputDate
                  type="date" 
                  class="form-control" 
                  [formControlName]="field"
                  [id]="getId('datepicker-'+field)"
                  (change)="checkDateOk($event,'greater',field)"
                />
                <input 
                  [class.d-none]="inputDate.value.length > 0"
                  class="form-control form-control-date"
                  autocomplete='off'
                  type="text"              
                  [id]="getId(field)"
                  [placeholder]="settings.formsContent[field].placeholder"
                  readonly    
                  (click)="focusDatePicker(inputDate)"
                />
                <div class="date-error-message">
                  <strong>La fecha debe ser mayor a la de hoy</strong>
                </div>
                <ng-container *ngIf="hasErrors(field)">
                  <div class="error-message">
                    <strong>{{hasErrors(field)}}</strong>
                  </div>
                </ng-container>
              </div>              
            </ng-container>

            <ng-container *ngSwitchCase="'double'">
              <div                 
                *ngFor="let doublefield of doubleFields[field]; trackBy: trackByFn"
                [class]="'form-group ' + settings.formsContent[field].fields[doublefield].type"                  
              >
                <label>{{ settings.formsContent[field].fields[doublefield].label }}</label>
                <input
                  class="form-control"
                  autocomplete='off'
                  [type]="settings.formsContent[field].fields[doublefield].type"
                  [formControlName]="doublefield"
                  [id]="getId(doublefield)"
                  [placeholder]="settings.formsContent[field].fields[doublefield].placeholder"
                />
                <ng-container *ngIf="hasErrors(field,true,doublefield)">
                  <div class="error-message">
                    <strong>{{hasErrors(field,true,doublefield)}}</strong>
                  </div>
                </ng-container>
              </div>              
            </ng-container>

            <ng-container *ngSwitchDefault>
              <label>{{ settings.formsContent[field].label }}</label>
              <input
                class="form-control"
                autocomplete='off'
                [type]="settings.formsContent[field].type"
                [formControlName]="field"
                [id]="getId(field)"
                [placeholder]="settings.formsContent[field].placeholder"
              />
            </ng-container>

            <ng-container *ngIf="settings.formsContent[field].type!='date' && 
                                 settings.formsContent[field].type!='double'">
              <ng-container *ngIf="hasErrors(field)">
                <div class="error-message">
                  <strong>{{hasErrors(field)}}</strong>
                </div>
              </ng-container>
            </ng-container>            
          </div>
        </ng-container>
        
        <ng-template #titleLabel>          
            <ng-container *ngIf="settings.formsContent[field].type==='title'; else imageGroup">
              <h6 [class.d-none]="settings.formsContent[field].hideImgContainer && settings.hideImgContainer">
                {{ settings.formsContent[field].label }}
              </h6>
            </ng-container>
        </ng-template>

        <ng-template #imageGroup>
            <div 
              [formGroupName]="field" 
              class="image-group"
              [class.d-none]="settings.hideImgContainer"
            >
              <!-- camera-outline -->
              <div
                #imageUploadContainer 
                class="image-upload-btn-container" 
                [id]="getId('image-upload-btn-container')"
                [class.inside-modal]="settings.isFromCustomTableActions"
              >
                  <input 
                    class="d-none" 
                    [id]="getId('image-upload-btn-input-file')" 
                    type="file" 
                    (change)="fileManager($event)"
                    accept="image/*"
                  />
                  <button 
                    *ngIf="!showImage(1)"
                    type="button"
                    [id]="getId('image-upload-btn')"  
                    title="Subir archivo"
                    class="text-decoration-none"
                    (click)="uploadImageCaller(imageUploadContainer)"
                  ><nb-icon icon="planificacion"></nb-icon>
                  </button>
                  <img 
                    *ngIf="showImage(1)" 
                    [src]="showImage(2)" 
                    [alt]="showImage(3)" 
                    [class.show-remover]="showImage(1)"
                  />
                  <i (click)="removeSelectedImg()">&times;</i>
                  <div class="overlay"></div>
              </div>

              <div 
                class="image-fields d-flex" 
                [class.flex-column]="!settings.formsContent[field].fields['imageDocente']"
                [class.justify-content-center]="!settings.formsContent[field].fields['imageDocente']"
                [class.flex-wrap]="settings.formsContent[field].fields['imageDocente']"
                [class.justify-content-between]="settings.formsContent[field].fields['imageDocente']"
                [class.general-container]="settings.formsContent[field].fields['imageDocente']"
                [class.inside-modal]="settings.isFromCustomTableActions"
              >                  
                <div class="input-container" *ngIf="settings.formsContent[field].fields['imageDocente']">
                  <label>{{ settings.formsContent[field].fields['imageDocente'].label }}</label>
                  <ng-select
                    class="form-control"
                    [class.image-status]="!settings.isFromCustomTableActions"
                    [class.is-in-modal]="settings.isFromCustomTableActions"
                    notFoundText="Elementos no encontrados"
                    [items]="settings.formsContent[field].fields['imageDocente'].options"
                    bindValue="id"
                    bindLabel="name"
                    [labelForId]="getId('imageDocente')"
                    formControlName="imageDocente"
                    [virtualScroll]="true"
                    [id]="getId('imageDocente')"
                    [placeholder]="settings.formsContent[field].fields['imageDocente'].placeholder"
                  >
                    <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                      <small>{{item.name}}</small>
                    </ng-template>
                  </ng-select>
                </div>
                  
                <div class="input-container" *ngIf="settings.formsContent[field].fields['imageCargo']">
                  <label>{{ settings.formsContent[field].fields['imageCargo'].label }}</label>
                  <input
                    class="form-control"
                    [class.image-description]="!settings.isFromCustomTableActions"
                    autocomplete='off'
                    type="text"
                    formControlName="imageCargo"
                    [id]="getId('imageCarago')"
                    [placeholder]="settings.formsContent[field].fields['imageCargo'].placeholder"
                  />
                </div>
                <div class="input-container" *ngIf="settings.formsContent[field].fields['imageDescription']">
                  <label>{{ settings.formsContent[field].fields['imageDescription'].label }}</label>
                  <input
                    class="form-control"
                    [class.image-description]="!settings.isFromCustomTableActions"
                    autocomplete='off'
                    type="text"
                    formControlName="imageDescription"
                    [id]="getId('imageDescription')"
                    [placeholder]="settings.formsContent[field].fields['imageDescription'].placeholder"
                  />
                  <ng-container *ngIf="hasErrors(field,true,'imageDescription',true) 
                                          && settings.isFromCustomTableActions">
                    <div class="error-message">
                      <strong>{{hasErrors(field,true,'imageDescription',true)}}</strong>
                    </div>
                  </ng-container>
                </div>
                
                <div class="input-container">
                  <label class="label-image-status">{{ settings.formsContent[field].fields['imageStatus'].label }}</label>
                  <ng-select
                    class="form-control"
                    [class.image-status]="!settings.isFromCustomTableActions"
                    [class.is-in-modal]="settings.isFromCustomTableActions"
                    notFoundText="Elementos no encontrados"
                    [items]="settings.formsContent[field].fields['imageStatus'].options"
                    bindValue="id"
                    bindLabel="name"
                    [labelForId]="getId('imageStatus')"
                    formControlName="imageStatus"
                    [virtualScroll]="true"
                    [id]="getId('imageStatus')"
                    [placeholder]="settings.formsContent[field].fields['imageStatus'].placeholder"
                  >
                    <ng-template ng-option-tmp let-item="item" let-search="searchTerm">
                      <small>{{item.name}}</small>
                    </ng-template>
                  </ng-select>
                  <ng-container *ngIf="hasErrors(field,true,'imageStatus',true) 
                                          && settings.isFromCustomTableActions">
                    <div class="error-message">
                      <strong>{{hasErrors(field,true,'imageStatus',true)}}</strong>
                    </div>
                  </ng-container>
                </div>                  
              </div>  

              <div *ngIf="!settings.isFromCustomTableActions" class="add-img-btn">
                <button 
                  type="button" 
                  class="btn btn-primary text-decoration-none py-1 px-4 mt-1 add-img-button"
                  [disabled]="disableAddImgBtn()"
                  (click)="addImage()"
                >Agregar imagen
                </button>

              </div>            
            </div> 
        </ng-template>
      </ng-container>        

      <div
        *ngIf="formInModalBtnConditioner()"
        class="btn-container"
        [class.one-row-form-btn-container]="settings.isOneRow"
      >
        <ng-container
          *ngFor="let btn of settings.buttons" 
          [ngSwitch]="btn"
        >
          <ng-container *ngSwitchCase="'cargarImagenes'">
            <button
              type="button" 
              class="btn btn-primary text-decoration-none py-1 px-4 mt-1"
              [disabled]="!componentForm.valid || sendingForm"
            >
              <span *ngIf="sendingForm" class="spinner-grow spinner-grow-sm"></span>
              {{ !sendingForm? 'Cargar imagenes':'Cargando..' }}
            </button>
          </ng-container>

          <ng-container *ngSwitchCase="'guardar'">
            <button 
              type="submit" 
              class="btn btn-primary text-decoration-none py-1 px-4 mt-1 submit-btn"
              [disabled]="disableBtn()"
            >
              <span *ngIf="sendingForm" class="spinner-grow spinner-grow-sm"></span>
              {{ !sendingForm? 'Guardar':'Guardando..' }}
            </button>
          </ng-container>

          <ng-container *ngSwitchCase="'agregar'">
            <button 
              type="submit" 
              class="btn btn-primary text-decoration-none py-1 px-4 mt-1 submit-btn"
              [disabled]="!componentForm.valid || sendingForm || isDateNotOk()"
            >
              <span *ngIf="sendingForm" class="spinner-grow spinner-grow-sm"></span>
              {{ !sendingForm? 'Agregar':'Agregando..' }}
            </button>
          </ng-container>

          <ng-container *ngSwitchCase="'buscar'">
            <button 
              type="button" 
              class="btn btn-primary text-decoration-none py-1 px-4 mt-1 submit-btn"
              [disabled]="!componentForm.valid || sendingForm || isDateNotOk()"
              (click)="searchAndFillTable()"
            >
              <span *ngIf="sendingForm" class="spinner-grow spinner-grow-sm"></span>
              {{ !sendingForm? 'Buscar':'Buscando..' }}
            </button>
          </ng-container>

          <ng-container *ngSwitchCase="'editar'">
            <button 
              type="submit" 
              class="btn btn-primary text-decoration-none py-1 px-4 mt-1 submit-btn"
              [disabled]="!componentForm.valid || sendingForm"
            >
              <span *ngIf="sendingForm" class="spinner-grow spinner-grow-sm"></span>
              {{ !sendingForm? 'Editar':'Editando..' }}
            </button>
          </ng-container>  

          <ng-container *ngSwitchDefault>
            <button 
              type="submit" 
              class="btn btn-primary text-decoration-none py-1 px-4 mt-1 submit-btn"
              [disabled]="!componentForm.valid || sendingForm"
            >
              <span>Cancelar</span>
            </button>
          </ng-container>       

        </ng-container>          
      </div>        
    </div>
</form>